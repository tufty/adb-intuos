ADB Intuos notes.

Identification word seems to be the same format as for the Ultrapads - .. .. xx xx yy yy .. ..

Identifiable by having 00 07 as the last two bytes, and by being set to handler 6a

Origin appears to be top left (makes sense).  

We get a continuous stream of packets even if the tool stays stationary.  

Stream starts with 2 packet that are *always* 7 bytes followed by (if there's time, a packet of) 8 bytes, and is always of the form 

80 82 x9 91 01 4f e0
Ax xx xx xx xx xx xx xx

The first packet seems to be an "in proximity" tool indicator.  With the standard stylus, the "x" is 0x2 when we're dealing with the tip, 0xa when we're dealing with the eraser.  Pressure, tilt or buttons don't seem to change it.

Breakdown:

80 TT T9 91 01 4f e0

TTT is Tool ID, as follows:

TTT & 0xFF7 == 0x822 : Standard Stylus
TTT & 0xFF7 == 0x812 : Inking Stylus
TTT & 0xFF7 == 0x832 : Stroke Stylus
TTT & 0xFF7 == 0x842 : Grip Stylus
TTT & 0xFF7 == 0x912 : Airbrush
TTT & 0xFF7 == 0x094 : 4D Mouse
TTT & 0xFF7 == 0x096 : Lens Cursor

TTT & 0x008 == 0x008 : Tool inverted (eraser)

To get a more general tool type, 

TTT & 0xf06 == 0x802 : Stylus
TTT & 0xf06 == 0x902 : Airbrush
TTT & 0xf06 == 0x004 : Mouse
TTT & 0xF06 == 0x006 : Puck

The trailing bytes don't change for my tablet, but are different for Bernard's.  Tablet ID, maybe.

The second packet encodes the "starting point" location.  

Breakdown:

AB XX XX YY YY nn nn nn

XXXX = x location
YYYY = y location

Resolution for 0608-A is 4f60 - 3f70

B is related to buttons, and only active for tip proximity (buttons not detected for eraser)

0bx000 = No buttons
0bx010 = Side button 1 pressed on entry
0bx100 = Side button 2 pressed on entry

Top bit is either set or not, doesn't seem consistent with a particular button state.

Hypothesis :

Pressure is 1024 levels for all tools (and for scrollwheels).  Tilt is +-60 degrees. This can be encoded in 3 bytes. 

First 10 bits appear to be pressure, naively encoded.

Next 7 bits x axis tilt.  zero -> maximum left, 7f -> maximum right
Next 7 bits y axis tilt.  zero -> maximum away from user, 7f -> maximum towards

encoding of last 3 bytes of 8 byte message
pppppppp ppxxxxxx xyyyyyyy


Stream continues with 3 and 6 byte packets, format unknown, and occasional 8 byte packets of the form 

Ax xx xx xx xx xx xx xx

These 8 byte packets appear to be of the same form as the initial entry packets. They are definitely triggered by changes of button state, but not pressure.

There are occasionally other 8 byte packets *not* starting with 0xa.  These appear to be triggered at the edges of the digitizer area if we go slowly enough.  Haven't looked into what they contain yet.

Hypothesis : 3 and 6 byte packets deal with most common changes in pointing device state - location, pressure and tilt. "uncommon" changes, i.e. button state changes, necessitate a "full" packet.

3 byte packets.

Bit 21 appears to correspond to a leftwards stroke.  Sign of X delta?
Bit 16 appears to correspond to upwards stroke.  Sign of Y delta?
- bits 12-16 Y delta?
- bits 17-21 X delta?

bits 0-3 y tilt delta ?
bits 4-7 x tilt delta ?
bits 8-11 pressure delta ?

Are x and y "deltas" 2's complement, or sign + data?  *very* slow movement in the "negative" direction results in the "sign" bit being set, and low values in the lsbs.  If we were dealing with 2's  or 1's complement, we'd expect to see lots of 0b11111 fields.  I postulate sign + some other coding.

..xxxxxy yyyy.. ........

Is what I'm assuming as pressure data instead a pair of multiplier / shift indicators for co-ordinates?  slow pen-up passes produce zeros here, fast ones put data in.  Sometimes.  I'm not sure it's pressure.

Some kind of delta modulation seems likely.

6 byte packets

Appear to be simply a pair of 3 byte packets.  There is scaling involved, however, as simply adding the values doesn't get a correct result.  multiplications of one or other packet by a constant power of 2 (to get a constant-scaled 8 bit delta) doesn't work either.

signs are consistent for first and second "packets" within a 6 byte packet.  For a right-left swipe, all x "deltas" are -ve, for example

Stream appears to consist of a number of 6 byte packets, with 3 byte packets every now and then (1 per 3-6 packets in normal circumstances).  

Hypothesis : 3 byte packets are "error correction" packets.
Against : eg on a left-right stroke, we might expect to see 3 byte packets with a -ve x delta when we "overshoot".  Haven't seen any of these.
For : If not, why bother with the 6 and 3 byte packet mix? Wacom couldn't physically get 200 samples/sec with ADB, why bother encoding 2 samples in one 6 byte packet in order to "fake" it? Nobody sees the samples, anyway, unless the driver is extrapolating time from the packets, which seems unlikely.

If they *are* error correction packets, they should be triggered by a threshold on the samples we're sending.  Can't see the original samples, though : cannot test. Can't see anything relevant in the 6-byte packets either. Have looked for (for example) cumulative bottom 2 bits per axis in 6-byte packets exceeds threshold (16, 32, etc) but found nothing concrete.

If the 6 byte packets are simply 2x3 byte packets, we're almost certainly looking at some sort of adaptive delta encoding.

** Well, Bernard got his o-scope out, and it appears that the 6 byte packets are simply 2 3 byte packets munged together in order to get the advertised 200pps (and they *do* hit that target, seems like Wacom care(d) about truth in advertising...

Stream ends with any packet whose last 2 bytes are FE 00 (usually simply 2 bytes, but sometimes 5 or 8 bytes with a 3 or  6 byte "extra" content packet first)




